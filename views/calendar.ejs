<%- include('templates/header', { title: 'Dashboard' , loggedIn, username }) %>

    <!-- Main Container -->
    <div class="container mt-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">My Calendar</h2>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#eventModal"
                onclick="openCreateModal()">
                <i class="bi bi-plus-circle"></i> New Event
            </button>
        </div>

        <!-- Events List -->
        <div class="row" id="eventsContainer">
            <div class="col-12">
                <div class="alert alert-info" id="loadingAlert">
                    <i class="bi bi-hourglass-split"></i> Loading events...
                </div>
            </div>
        </div>
    </div>

    <!-- Event Modal -->
    <div class="modal fade" id="eventModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Create Event</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="eventForm">
                        <input type="hidden" id="eventId">

                        <div class="mb-3">
                            <label for="eventTitle" class="form-label">Title <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="eventTitle" required>
                        </div>

                        <div class="mb-3">
                            <label for="eventDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="eventDescription" rows="3"></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="eventStart" class="form-label">Start Date & Time <span
                                    class="text-danger">*</span></label>
                            <input type="datetime-local" class="form-control" id="eventStart" required>
                        </div>

                        <div class="mb-3">
                            <label for="eventEnd" class="form-label">End Date & Time <span
                                    class="text-danger">*</span></label>
                            <input type="datetime-local" class="form-control" id="eventEnd" required>
                        </div>

                        <div class="mb-3">
                            <label for="eventColor" class="form-label">Color</label>
                            <div class="d-flex gap-2 align-items-center">
                                <input type="color" class="form-control form-control-color" id="eventColor"
                                    value="#3b82f6" style="width: 60px;">
                                <span class="text-muted">Choose an event color</span>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEvent()">Save Event</button>
                </div>
            </div>
        </div>
    </div>

    <%- include('templates/footer') %>

        <script>
            let currentEventId = null;
            const modal = new bootstrap.Modal(document.getElementById('eventModal'));

            // Load events on page load
            document.addEventListener('DOMContentLoaded', () => {
                loadEvents();
            });

            async function loadEvents() {
                try {
                    const response = await fetch('/api/events');
                    const events = await response.json();
                    displayEvents(events);
                } catch (error) {
                    console.error('Error loading events:', error);
                    document.getElementById('eventsContainer').innerHTML = `
          <div class="col-12">
            <div class="alert alert-danger">Failed to load events. Please refresh the page.</div>
          </div>
        `;
                }
            }

            function displayEvents(events) {
                const container = document.getElementById('eventsContainer');

                if (events.length === 0) {
                    container.innerHTML = `
          <div class="col-12">
            <div class="alert alert-info">
              <i class="bi bi-calendar-x"></i> No events yet. Create your first event!
            </div>
          </div>
        `;
                    return;
                }

                container.innerHTML = events.map(event => {
                    const startDate = new Date(event.start_datetime);
                    const endDate = new Date(event.end_datetime);
                    const startStr = startDate.toLocaleString();
                    const endStr = endDate.toLocaleString();

                    return `
          <div class="col-md-6 col-lg-4 mb-3">
            <div class="card h-100 border-start border-4" style="border-left-color: ${event.color} !important;">
              <div class="card-body">
                <h5 class="card-title">${escapeHtml(event.title)}</h5>
                <p class="card-text text-muted small">
                  <i class="bi bi-clock"></i> ${startStr}<br>
                  <i class="bi bi-clock-fill"></i> ${endStr}
                </p>
                ${event.description ? `<p class="card-text">${escapeHtml(event.description)}</p>` : ''}
              </div>
              <div class="card-footer bg-transparent border-0 d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary" onclick="editEvent(${event.id})">
                  <i class="bi bi-pencil"></i> Edit
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteEvent(${event.id})">
                  <i class="bi bi-trash"></i> Delete
                </button>
              </div>
            </div>
          </div>
        `;
                }).join('');
            }

            function openCreateModal() {
                currentEventId = null;
                document.getElementById('modalTitle').textContent = 'Create Event';
                document.getElementById('eventForm').reset();
                document.getElementById('eventColor').value = '#3b82f6';
            }

            async function editEvent(id) {
                try {
                    const response = await fetch('/api/events');
                    const events = await response.json();
                    const event = events.find(e => e.id === id);

                    if (!event) return;

                    currentEventId = id;
                    document.getElementById('modalTitle').textContent = 'Edit Event';
                    document.getElementById('eventId').value = event.id;
                    document.getElementById('eventTitle').value = event.title;
                    document.getElementById('eventDescription').value = event.description || '';
                    document.getElementById('eventStart').value = formatDateTimeLocal(event.start_datetime);
                    document.getElementById('eventEnd').value = formatDateTimeLocal(event.end_datetime);
                    document.getElementById('eventColor').value = event.color;

                    modal.show();
                } catch (error) {
                    console.error('Error loading event:', error);
                    alert('Failed to load event details');
                }
            }

            async function saveEvent() {
                const title = document.getElementById('eventTitle').value.trim();
                const description = document.getElementById('eventDescription').value.trim();
                const start = document.getElementById('eventStart').value;
                const end = document.getElementById('eventEnd').value;
                const color = document.getElementById('eventColor').value;

                if (!title || !start || !end) {
                    alert('Please fill in all required fields');
                    return;
                }

                if (new Date(start) >= new Date(end)) {
                    alert('End time must be after start time');
                    return;
                }

                const eventData = {
                    title,
                    description,
                    start_datetime: start,
                    end_datetime: end,
                    color
                };

                try {
                    let response;
                    if (currentEventId) {
                        response = await fetch(`/api/events/${currentEventId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(eventData)
                        });
                    } else {
                        response = await fetch('/api/events', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(eventData)
                        });
                    }

                    if (response.ok) {
                        modal.hide();
                        loadEvents();
                    } else {
                        alert('Failed to save event');
                    }
                } catch (error) {
                    console.error('Error saving event:', error);
                    alert('Failed to save event');
                }
            }

            async function deleteEvent(id) {
                if (!confirm('Are you sure you want to delete this event?')) return;

                try {
                    const response = await fetch(`/api/events/${id}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        loadEvents();
                    } else {
                        alert('Failed to delete event');
                    }
                } catch (error) {
                    console.error('Error deleting event:', error);
                    alert('Failed to delete event');
                }
            }

            function formatDateTimeLocal(datetime) {
                const date = new Date(datetime);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        </script>